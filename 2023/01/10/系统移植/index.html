<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文包含 u-boot 、kernel 、rootfs 的解析编译移植，rootfs 的介绍、语法、编写，kernel 的裁剪。">
<meta property="og:type" content="article">
<meta property="og:title" content="系统移植">
<meta property="og:url" content="http://example.com/2023/01/10/%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/index.html">
<meta property="og:site_name" content="境">
<meta property="og:description" content="本文包含 u-boot 、kernel 、rootfs 的解析编译移植，rootfs 的介绍、语法、编写，kernel 的裁剪。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/image/SYStftp.png">
<meta property="og:image" content="http://example.com/image/SYSnfs.png">
<meta property="og:image" content="http://example.com/image/SYSnfs.png">
<meta property="og:image" content="http://example.com/image/SYSproduct.png">
<meta property="og:image" content="http://example.com/image/SYSproduct1.png">
<meta property="og:image" content="http://example.com/image/U-BOOTerr1.png">
<meta property="og:image" content="http://example.com/image/U-BOOTerr2.png">
<meta property="og:image" content="http://example.com/image/U-BOOTerr3.png">
<meta property="og:image" content="http://example.com/image/KERstart.png">
<meta property="article:published_time" content="2023-01-10T14:07:08.000Z">
<meta property="article:modified_time" content="2023-08-12T15:41:09.766Z">
<meta property="article:author" content="XiaoMingMingBai">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/image/SYStftp.png">

<link rel="canonical" href="http://example.com/2023/01/10/%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>系统移植 | 境</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">境</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/xiaomingmingbai" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/10/%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="XiaoMingMingBai">
      <meta itemprop="description" content="选择有时候比努力更重要">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="境">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          系统移植
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-10 22:07:08" itemprop="dateCreated datePublished" datetime="2023-01-10T22:07:08+08:00">2023-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-12 23:41:09" itemprop="dateModified" datetime="2023-08-12T23:41:09+08:00">2023-08-12</time>
              </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>29 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本文包含 <code>u-boot</code> 、<code>kernel</code> 、<code>rootfs</code> 的解析编译移植，<code>rootfs</code> 的介绍、语法、编写，<code>kernel</code> 的裁剪。</p>
<span id="more"></span>

<h1 id="系统移植"><a href="#系统移植" class="headerlink" title="系统移植"></a>系统移植</h1><h2 id="移植前准备"><a href="#移植前准备" class="headerlink" title="移植前准备"></a>移植前准备</h2><h3 id="1-Ubuntu-系统安装交叉编译器"><a href="#1-Ubuntu-系统安装交叉编译器" class="headerlink" title="1. Ubuntu 系统安装交叉编译器"></a>1. Ubuntu 系统安装<strong>交叉编译器</strong></h3><p>用来编译 <code>u-boot</code> 、<code>kernel</code> 、<code>rootfs</code> 。</p>
<ol>
<li>创建文件夹并拷贝文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> toolchain</span><br><span class="line"><span class="built_in">cp</span> /mnt/hgfs/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf.tar toolchain/</span><br></pre></td></tr></table></figure></li>
<li>解压文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> toolchain</span><br><span class="line">tar -xvf gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf.tar</span><br><span class="line"><span class="built_in">mv</span> gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf  gcc-7.5.0 <span class="comment">## 简化目录名</span></span><br></pre></td></tr></table></figure></li>
<li>配置PATH环境变量<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/bash.bashrc</span><br><span class="line"><span class="comment"># 在文件末尾添加</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/ming/toolchain/gcc-7.5.0/bin</span><br><span class="line"><span class="comment"># 使环境变量生效</span></span><br><span class="line"><span class="built_in">source</span> /etc/bash.bashrc</span><br></pre></td></tr></table></figure></li>
<li>测试<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-gcc -v</span><br><span class="line"><span class="comment"># gcc version 7.5.0 (Linaro GCC 7.5-2019.12)</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-Ubuntu-系统安装tftp服务"><a href="#2-Ubuntu-系统安装tftp服务" class="headerlink" title="2. Ubuntu 系统安装tftp服务"></a>2. Ubuntu 系统安装<strong>tftp服务</strong></h3><p>用来传输各种文件，比如 <code>uImage</code> 、<code>dtb</code> 等。<br><img src="/../image/SYStftp.png" alt="tftp"></p>
<ol>
<li>安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install tftpd-hpa tftp-hpa</span><br></pre></td></tr></table></figure></li>
<li>修改tftp配置文件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/default/tftpd-hpa</span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line"><span class="comment"># TFTP_USERNAME=&quot;tftp&quot; # 服务用户名</span></span><br><span class="line"><span class="comment"># TFTP_DIRECTORY=&quot;/home/ming/tftpboot&quot; # 服务目录</span></span><br><span class="line"><span class="comment"># TFTP_ADDRESS=&quot;:69&quot; # 服务端口</span></span><br><span class="line"><span class="comment"># TFTP_OPTIONS=&quot;-c -s -l&quot; # 服务参数</span></span><br><span class="line"><span class="built_in">mkdir</span> /home/ming/tftpboot</span><br></pre></td></tr></table></figure></li>
<li>重启服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service tftpd-hpa restart</span><br></pre></td></tr></table></figure></li>
<li>本地测试<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftp 127.0.0.1</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-Ubuntu-系统安装nfs服务"><a href="#3-Ubuntu-系统安装nfs服务" class="headerlink" title="3. Ubuntu 系统安装nfs服务"></a>3. Ubuntu 系统安装<strong>nfs服务</strong></h3><p>用来通过网络的方式从ubuntu服务器中挂载根文件系统。<br><img src="/../image/SYSnfs.png" alt="nfs"></p>
<ol>
<li>安装nfs服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nfs-kernel-server</span><br></pre></td></tr></table></figure></li>
<li>修改nfs服务的配置文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/exports</span><br><span class="line"><span class="comment"># 最后添加</span></span><br><span class="line"><span class="comment"># /home/ming/rootfs *(rw,sync,no_root_squash,no_subtree_check)</span></span><br><span class="line"><span class="comment"># 解释：</span></span><br><span class="line"><span class="comment"># /home/ming/rootfs：根文件系统的路径，修改为自己的路径</span></span><br><span class="line"><span class="comment"># * ---&gt; 指所有的用户</span></span><br><span class="line"><span class="comment"># rw ---&gt; 对根文件系统可读可写的权限</span></span><br><span class="line"><span class="comment"># sync ---&gt; 同步文件</span></span><br><span class="line"><span class="comment"># no_root_squash ---&gt; 来访的root用户保持root帐号权限</span></span><br><span class="line"><span class="comment"># no_subtree_check ---&gt; 即使输出目录是一个子目录，</span></span><br><span class="line"><span class="comment"># nfs服务器也不检查其父目录的权限，这样可以提高效率；</span></span><br></pre></td></tr></table></figure></li>
<li>在Ubuntu系统中创建根文件系统的目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /home/ming/rootfs</span><br><span class="line"><span class="built_in">mv</span> /mnt/hgfs/rootfs.tar.xz /home/ming/rootfs/</span><br><span class="line">tar -xvf rootfs.tar.xz</span><br></pre></td></tr></table></figure></li>
<li>重启nfs服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service nfs-kernel-server restart</span><br></pre></td></tr></table></figure></li>
<li>本地测试<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs 127.0.0.1:/home/ming/rootfs    /mnt</span><br><span class="line"><span class="comment"># 没有问题后取消挂载</span></span><br><span class="line">sudo umount /mnt</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="开发阶段部署和启动"><a href="#开发阶段部署和启动" class="headerlink" title="开发阶段部署和启动"></a>开发阶段部署和启动</h2><p><img src="/../image/SYSnfs.png" alt="nfs"></p>
<ol>
<li>拷贝 <strong>uImage</strong> 和 <strong>stm32mp157a-fsmp1a.dtb</strong> 文件到ubuntu系统的~&#x2F;tftpboot目录下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /mnt/hgfs/uImage ~/tftpboot/</span><br><span class="line"><span class="built_in">cp</span> /mnt/hgfs/stm32mp157a-fsmp1a.dtb ~/tftpboot/</span><br></pre></td></tr></table></figure></li>
<li>使用 tftp 命令下载 <strong>uImage</strong> 到内存中<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftp 0xc2000000 uImage</span><br></pre></td></tr></table></figure></li>
<li>使用 tftp 命令下载 <strong>stm32mp157a-fsmp1a.dtb</strong> 文件到内存中<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftp 0xc4000000 stm32mp157a-fsmp1a.dtb</span><br></pre></td></tr></table></figure></li>
<li>设置 u-boot 中的环境变量 <strong>bootargs</strong> 自启动参数<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs root=/dev/nfs  nfsroot=192.168.2.250:/home/linux/rootfs,tcp,v4 rw console=ttySTM0,115200 init=/linuxrc ip=192.168.2.100</span><br><span class="line">saveenv</span><br><span class="line"><span class="comment"># 解析:</span></span><br><span class="line"><span class="comment"># bootargs环境变量中的值：</span></span><br><span class="line"><span class="comment"># root=/dev/nfs  ：使用nfs网络文件系统</span></span><br><span class="line"><span class="comment"># nfsroot=192.168.2.250:/home/linux/rootfs,</span></span><br><span class="line"><span class="comment"># tcp,v4  ： nfs基于TCP实现，v4版本</span></span><br><span class="line"><span class="comment"># rw ： 对跟文件系统具有可读可写的权限</span></span><br><span class="line"><span class="comment"># console=ttySTM0,115200 	：使用的是哪个串口，及串口的波特率</span></span><br><span class="line"><span class="comment"># init=/linuxrc  ： 挂载根文件系统之后，允许的第一个程序</span></span><br><span class="line"><span class="comment"># ip=192.168.2.100  ： 开发板的IP地址</span></span><br></pre></td></tr></table></figure></li>
<li>启动开发板的 linux 系统 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootm 0xc2000000 - 0xc4000000</span><br></pre></td></tr></table></figure></li>
<li>设置开发板的系统为自动加载自动启动的方式<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd <span class="string">&quot;tftp 0xc2000000 uImage;tftp 0xc4000000 stm32mp157a-fsmp1a.dtb;bootm 0xc2000000 - 0xc4000000&quot;</span></span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure></li>
<li>编写应用程序，在开发板中允许应用程序<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 编写应用程序</span></span><br><span class="line"><span class="comment"># 2. 交叉编译</span></span><br><span class="line">arm-linux-gnueabihf-gcc hello.c -o hello</span><br><span class="line"><span class="comment"># 3. 拷贝到ubuntu系统的~/rootfs目录下</span></span><br><span class="line"><span class="built_in">cp</span> hello ~/rootfs/</span><br><span class="line"><span class="comment"># 4. 在开发板中运行</span></span><br><span class="line">./hello</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="产品阶段部署和启动"><a href="#产品阶段部署和启动" class="headerlink" title="产品阶段部署和启动"></a>产品阶段部署和启动</h2><p><img src="/../image/SYSproduct.png" alt="system product"><br><img src="/../image/SYSproduct1.png" alt="system product"></p>
<ol>
<li>拷贝 <strong>uImage</strong> 和 <strong>stm32mp157a-fsmp1a.dtb</strong> <strong>ramdisk.img</strong> 文件到ubuntu系统的~&#x2F;tftpboot目录下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /mnt/hgfs/uImage ~/tftpboot/</span><br><span class="line"><span class="built_in">cp</span> /mnt/hgfs/stm32mp157a-fsmp1a.dtb ~/tftpboot/</span><br><span class="line"><span class="built_in">cp</span> /mnt/hgfs/ramdisk.img ~/tftpboot/</span><br></pre></td></tr></table></figure></li>
<li>部署 <strong>uImage</strong> 镜像到TF卡的 <strong>bootfs</strong> 分区<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 0</span><br><span class="line">tftp 0xc2000000 uImage</span><br><span class="line">mmc write 0xc2000000 0x2000 0x4000</span><br><span class="line"><span class="comment"># 解释：</span></span><br><span class="line"><span class="comment"># 0x2000 : TF卡的bootfs分区的起始地址</span></span><br><span class="line"><span class="comment"># 0x4000 : 搬移的大小</span></span><br><span class="line"><span class="comment"># Bytes transferred = 7497520 (726730 hex) ，7497520 / 512 = 14643 = 0x3933</span></span><br></pre></td></tr></table></figure></li>
<li>部署 <strong>stm32mp157a-fsmp1a.dtb</strong> 文件到TF卡的 <strong>rootfs</strong> 分区<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 0</span><br><span class="line">tftp 0xc2000000 stm32mp157a-fsmp1a.dtb</span><br><span class="line">mmc write 0xc2000000 0x10000 0x200</span><br><span class="line"><span class="comment"># 解释：</span></span><br><span class="line"><span class="comment"># Bytes transferred = 76186 (1299a hex), 76186 / 512 = 148 = 0x94</span></span><br></pre></td></tr></table></figure></li>
<li>部署 <strong>ramdisk.img</strong> 镜像文件到tf卡的 <strong>rootfs</strong> 分区<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 0</span><br><span class="line">tftp 0xc2000000 ramdisk.img</span><br><span class="line">mmc write 0xc2000000 0x21500 0x21500</span><br><span class="line"><span class="comment"># 解释：</span></span><br><span class="line"><span class="comment"># Bytes transferred = 16345960 (f96b68 hex), 16345960 / 512 = 31925 = 0x7CB5</span></span><br></pre></td></tr></table></figure></li>
<li>设置 u-boot 中的 bootargs 自启动参数<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">setenv bootargs root=/dev/ram console=ttySTM0,115200 initrd=0xc5000040,0x1000000 rw init=/linuxrc rootfstype=ext4</span><br><span class="line">saveenv</span><br><span class="line"><span class="comment"># 解释：</span></span><br><span class="line"><span class="comment"># root=/dev/ram : 使用ram文件系统</span></span><br><span class="line"><span class="comment"># console=ttySTM0,115200 : 使用串口打印内核信息，波特率115200</span></span><br><span class="line"><span class="comment"># initrd=0xc5000040,0x1000000 : 根文件系统的加载地址，大小</span></span><br><span class="line"><span class="comment">#    根文件系统的加载地址为 ：0xc5000000</span></span><br><span class="line"><span class="comment">#    + 0x40 ：表示跳过ramdisk.img镜像文件的64字节的文件头</span></span><br><span class="line"><span class="comment"># rw : 可读可写的权限</span></span><br><span class="line"><span class="comment"># init=/linuxrc : 挂载根文件系统之后运行的1号程序</span></span><br><span class="line"><span class="comment"># rootfstype=ext4 : 根文件系统的格式</span></span><br></pre></td></tr></table></figure></li>
<li>启动开发板的 linux 系统 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mmc dev 0</span><br><span class="line">mmc <span class="built_in">read</span> 0xc2000000 0x200 0x4000</span><br><span class="line">mmc <span class="built_in">read</span> 0xc4000000 0x10000 0x200</span><br><span class="line">mmc <span class="built_in">read</span> 0xc5000000 0x21500 0x21500</span><br><span class="line">bootm 0xc2000000 0xc5000000 0xc4000000</span><br></pre></td></tr></table></figure></li>
<li>设置开发板的系统为自动加载自动启动的方式<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd <span class="string">&quot;mmc dev 0;mmc read 0xc2000000 0x2000 0x4000;mmc read 0xc4000000 0x10000 0x200;mmc read 0xc5000000 0x21500 0x21500;bootm 0xc2000000 0xc5000000 0xc4000000&quot;</span></span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="TF-卡的分区"><a href="#TF-卡的分区" class="headerlink" title="TF 卡的分区"></a>TF 卡的分区</h3><ol>
<li>删除原有分区<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo parted -s /dev/sdv mklabel msdos</span><br><span class="line"><span class="comment"># 如果正在使用需要卸载</span></span><br><span class="line"><span class="comment"># sudo umount /dev/sdvx (x = 1 ~ 5)</span></span><br></pre></td></tr></table></figure></li>
<li>重新分区<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sudo sgdisk --resize-table=128 -a 1 -n 1:34:545 -c 1:fsbl1 -n 2:546:1057 -c 2:fsbl2 -n 3:1058:5153 -c 3:ssbl -n 4:5154:136225 -c 4:bootfs -n 5:136226 -c 5:rootfs -A 4:<span class="built_in">set</span>:2 -p /dev/sdb -g</span><br><span class="line"><span class="comment"># 解释：</span></span><br><span class="line"><span class="comment"># sgdisk : 分区的命令</span></span><br><span class="line"><span class="comment"># --resize-table=128 -a 1 : 分区对齐处理</span></span><br><span class="line"><span class="comment"># -n 1:34:545 -c 1:fsbl1 </span></span><br><span class="line"><span class="comment"># -n 2:546:1057 -c 2:fsbl2 </span></span><br><span class="line"><span class="comment"># -n 3:1058:5153 -c 3:ssbl </span></span><br><span class="line"><span class="comment"># -n 4:5154:136225 -c 4:bootfs </span></span><br><span class="line"><span class="comment"># -n 5:136226 -c 5:rootfs </span></span><br><span class="line"><span class="comment"># -n(创建分区) 分区编号:起始块号:终止块号 -c(分区名) 分区编号:分区名</span></span><br><span class="line"><span class="comment"># -A 4:set:2 	---&gt; 设置分区的属性</span></span><br><span class="line"><span class="comment"># -p /dev/sdb -g	----&gt; 打印分区的结果</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="u-boot"><a href="#u-boot" class="headerlink" title="u-boot"></a>u-boot</h1><h2 id="分析-u-boot-源码"><a href="#分析-u-boot-源码" class="headerlink" title="分析 u-boot 源码"></a>分析 u-boot 源码</h2><ol>
<li>拷贝 <strong>u-boot</strong> 源码到 ubuntu 系统的 ~&#x2F;u-boot 目录下<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> -r /mnt/hgfs/u-boot-2021.07.tar.bz2 ~/u-boot</span><br><span class="line">tar -xvf u-boot-2021.07.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> u-boot-2021.07</span><br></pre></td></tr></table></figure></li>
<li><strong>u-boot</strong> 目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># api		---&gt; api接口</span></span><br><span class="line"><span class="comment"># arch	---&gt; 架构相关的代码 *</span></span><br><span class="line"><span class="comment"># board	---&gt; 板子相关的代码 *</span></span><br><span class="line"><span class="comment"># cmd		---&gt; 命令相关代码</span></span><br><span class="line"><span class="comment"># configs ---&gt; 板子的默认的配置文件 *</span></span><br><span class="line"><span class="comment"># disk	---&gt; 闪存相关代码</span></span><br><span class="line"><span class="comment"># doc		---&gt; 帮助文档 *</span></span><br><span class="line"><span class="comment"># drivers ---&gt; 驱动相关代码 *</span></span><br><span class="line"><span class="comment"># dts		---&gt; 设备树文件 *</span></span><br><span class="line"><span class="comment"># env		---&gt; 环境配置文件</span></span><br><span class="line"><span class="comment"># examples	---&gt; 案例</span></span><br><span class="line"><span class="comment"># fs		---&gt; 文件系统</span></span><br><span class="line"><span class="comment"># include ---&gt; 头文件</span></span><br><span class="line"><span class="comment"># lib		---&gt; 库</span></span><br><span class="line"><span class="comment"># Makefile ---&gt; 工程配置编译 *</span></span><br><span class="line"><span class="comment"># net		---&gt; 网络相关代码</span></span><br><span class="line"><span class="comment"># post	---&gt; 电源相关代码</span></span><br><span class="line"><span class="comment"># README	---&gt; 帮助文件 *</span></span><br><span class="line"><span class="comment"># scripts	----&gt; 脚本文件</span></span><br><span class="line"><span class="comment"># test	---&gt; 测试代码</span></span><br><span class="line"><span class="comment"># tools	---&gt; 工具代码</span></span><br></pre></td></tr></table></figure></li>
<li>阅读参考文档</li>
</ol>
<h2 id="u-boot-启动流程"><a href="#u-boot-启动流程" class="headerlink" title="u-boot 启动流程"></a>u-boot 启动流程</h2><ul>
<li>第一阶段-汇编</li>
</ul>
<ol>
<li>初始化异常向量表</li>
<li>设置ARM核为SVC模式，关中断</li>
<li>关闭页表，cache，mmu</li>
<li>关看门狗</li>
<li>初始化时钟</li>
<li>初始化内存</li>
<li>初始化串口</li>
<li>初始化栈</li>
<li>清bss段</li>
</ol>
<ul>
<li>第二阶段-C</li>
</ul>
<ol>
<li>各种硬件的初始化（解析设备树，板级初始化，时钟初始化，串口初始化，emmc初始化，网卡初始化）</li>
<li>读取bootdelay参数，如果倒计时为0前按下了任意键进入交互模式，就可以通过命令来操作uboot如果倒计时为0的时候没有安下任意键，系统读取bootcmd来启动内核。</li>
</ol>
<h2 id="配置编译"><a href="#配置编译" class="headerlink" title="配置编译"></a>配置编译</h2><ol>
<li>拷贝 <strong>u-boot</strong> 源码到ubuntu中，解压<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /mnt/hgfs/u-boot-2021.07.tar.bz2 ~/</span><br><span class="line">tar -xvf u-boot-2021.07.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> u-boot-2021.07</span><br></pre></td></tr></table></figure></li>
<li>修改 <strong>Makefile</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim Makefile</span><br><span class="line"><span class="comment"># 266 ifeq ($(HOSTARCH),$(ARCH))</span></span><br><span class="line"><span class="comment"># 267 CROSS_COMPILE ?= </span></span><br><span class="line"><span class="comment"># 268 endif</span></span><br><span class="line"><span class="comment"># 修改</span></span><br><span class="line"><span class="comment"># 266 ifeq (arm,arm)</span></span><br><span class="line"><span class="comment"># 267 CROSS_COMPILE ?= arm-linux-gnueabihf-</span></span><br><span class="line"><span class="comment"># 268 endif</span></span><br></pre></td></tr></table></figure></li>
<li>生成 <code>.config</code> 文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make stm32mp15_basic_defconfig</span><br></pre></td></tr></table></figure></li>
<li>根据 DK1 板子的设备树文件拷贝生成 FSMP1A 板子的设备树文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> <span class="built_in">arch</span>/arm/dts/stm32mp15*dk*</span><br><span class="line"><span class="built_in">cp</span> <span class="built_in">arch</span>/arm/dts/stm32mp157a-dk1.dts  <span class="built_in">arch</span>/arm/dts/stm32mp157a-fsmp1a.dts</span><br><span class="line"><span class="built_in">cp</span> <span class="built_in">arch</span>/arm/dts/stm32mp157a-dk1-u-boot.dtsi  <span class="built_in">arch</span>/arm/dts/stm32mp157a-fsmp1a-u-boot.dtsi </span><br><span class="line"><span class="built_in">cp</span> <span class="built_in">arch</span>/arm/dts/stm32mp15xx-dkx.dtsi  <span class="built_in">arch</span>/arm/dts/stm32mp15xx-fsmp1x.dtsi</span><br></pre></td></tr></table></figure></li>
<li>修改 <code>stm32mp157a-fsmp1a.dts</code><figure class="highlight dts"><figcaption><span>&#123;.line-numbers&#125;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32mp15xx-dkx.dtsi&quot;</span>                </span></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;STMicroelectronics STM32MP157A-DK1 Discovery Board&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;st,stm32mp157a-dk1&quot;</span>, <span class="string">&quot;st,stm32mp157&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="comment">// 修改为：</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stm32mp15xx-fsmp1x.dtsi&quot;</span></span></span><br><span class="line"><span class="title class_">/</span> <span class="punctuation">&#123;</span>       </span><br><span class="line"><span class="attr">model</span> <span class="operator">=</span> <span class="string">&quot;MING STM32MP157A-FSMP1A Discovery Board&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;st,stm32mp157a-fsmp1a&quot;</span>, <span class="string">&quot;st,stm32mp157&quot;</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure></li>
<li>添加 fsmp1a 设备树编译信息 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim <span class="built_in">arch</span>/arm/dts/Makefile</span><br><span class="line"><span class="comment"># 1061 dtb-$(CONFIG_STM32MP15x) += \</span></span><br><span class="line"><span class="comment"># 1062     stm32mp157a-dk1.dtb \</span></span><br><span class="line"><span class="comment"># 添加</span></span><br><span class="line"><span class="comment"># 1063     stm32mp157a-fsmp1a.dtb \  </span></span><br></pre></td></tr></table></figure></li>
<li>编译<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j8 all</span><br></pre></td></tr></table></figure></li>
<li>将编译生成的 <code>u-boot</code> 镜像文件部署到TF卡<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/sdtools</span><br><span class="line"><span class="built_in">cp</span> 路径/u-boot-spl.stm32   路径/sdtools</span><br><span class="line"><span class="built_in">cp</span> 路径/u-boot.img   路径/sdtools</span><br></pre></td></tr></table></figure></li>
<li>使用 <code>.sh</code> 脚本部署 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># [] : test 命令， 可以用于整数，字符串比较，文件类型判断</span></span><br><span class="line"><span class="comment"># -eq : 判断整数是否相等</span></span><br><span class="line"><span class="comment"># $# : 执行脚本文件时参数的个数</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -eq 1 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="comment"># == ： 判断字符串是否相等</span></span><br><span class="line"><span class="comment"># $1 : 执行脚本文件时传递的第一个参数</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> == <span class="string">&quot;help&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;usage: ./sdtools.sh /dev/sdb(blockdevice)&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="comment"># -b : 判断$1参数是否为块设备文件</span></span><br><span class="line"><span class="comment"># ! : 取非运算</span></span><br><span class="line"><span class="keyword">elif</span> [ ! -b <span class="variable">$1</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;device <span class="variable">$1</span> :It&#x27;s not a block device&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;usage: ./sdtools.sh /dev/sdb(blockdevice)&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;是否需要重新分区y/n? &quot;</span> chose</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$chose</span> == <span class="string">&quot;y&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;*****************开始重新分区****************************&quot;</span></span><br><span class="line"><span class="comment"># 取消分区的挂载</span></span><br><span class="line"><span class="keyword">for</span> (( i=<span class="number">1</span>; i &lt;=<span class="number">5</span>; i++)) </span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">sudo umount <span class="variable">$&#123;1&#125;</span><span class="variable">$&#123;i&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment"># 删除原有的分区</span></span><br><span class="line">sudo parted -s <span class="variable">$1</span>  mklabel msdos</span><br><span class="line"><span class="comment"># 执行重新分区的命令</span></span><br><span class="line">sudo sgdisk --resize-table=128 -a 1 -n 1:34:545 -c 1:fsbl1 -n 2:546:1057 -c 2:fsbl2 -n 3:1058:5153 -c 3:ssbl -n 4:5154:136225 -c 4:bootfs -n 5:136226 -c 5:rootfs -A 4:<span class="built_in">set</span>:2 -p <span class="variable">$1</span> -g</span><br><span class="line"><span class="comment"># sgdisk ---&gt; 重新分区的命令</span></span><br><span class="line"><span class="comment"># --resize-table=128 -a 1   --&gt; 分区对齐</span></span><br><span class="line"><span class="comment"># -n 1:34:545 -c 1:fsbl1 </span></span><br><span class="line"><span class="comment">#   ---&gt; -n(重新分区的参数)  分区编号:起始块号:终止块号 -c(分区名)  分区编号:分区名字</span></span><br><span class="line"><span class="comment"># -n 2:546:1057 -c 2:fsbl2 </span></span><br><span class="line"><span class="comment"># -n 3:1058:5153 -c 3:ssbl </span></span><br><span class="line"><span class="comment"># -n 4:5154:136225 -c 4:bootfs </span></span><br><span class="line"><span class="comment"># -n 5:136226 -c 5:rootfs </span></span><br><span class="line"><span class="comment">#   ---&gt; -n(重新分区的参数)  分区编号:起始块号(剩余空间都属于这个分区) -c(分区名)  分区编号:分区名字</span></span><br><span class="line"><span class="comment"># -A 4:set:2    ---&gt; 设置分区的属性</span></span><br><span class="line"><span class="comment"># -p $1 -g		---&gt; 打印分区的结果信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 关于更多sgdisk命令的使用可以man sgdisk或者sgdisk --help查看帮助手册</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;*****************分区完成********************************&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$chose</span> == <span class="string">&quot;n&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;*****************跳过分区********************************&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;选择错误，请重试...&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;选择烧写模式&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;0.basic非安全烧写&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1.trusted安全烧写&quot;</span></span><br><span class="line"><span class="built_in">read</span> -p <span class="string">&quot;请输入你的选择&gt; &quot;</span> <span class="built_in">which</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$which</span> -eq 0 ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;****************开始basic烧写****************************&quot;</span></span><br><span class="line"><span class="comment"># dd : 拷贝烧写的命令</span></span><br><span class="line"><span class="comment"># if : 指定输入文件</span></span><br><span class="line"><span class="comment"># of : 指定输出文件</span></span><br><span class="line"><span class="comment"># conv=fdatasync：将输入文件中的内容读到缓冲区之后，在写入到输出文件中</span></span><br><span class="line"><span class="comment"># sudo dd if=u-boot-spl.stm32 of=/dev/sdb1 conv=fdatasync</span></span><br><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=u-boot-spl.stm32 of=<span class="string">&quot;<span class="variable">$11</span>&quot;</span> conv=fdatasync</span><br><span class="line"></span><br><span class="line"><span class="comment"># sudo dd if=u-boot-spl.stm32 of=/dev/sdb2 conv=fdatasync</span></span><br><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=u-boot-spl.stm32 of=<span class="string">&quot;<span class="variable">$12</span>&quot;</span> conv=fdatasync</span><br><span class="line"></span><br><span class="line"><span class="comment"># sudo dd if=u-boot.img  of=/dev/sdb3 conv=fdatasync</span></span><br><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=u-boot.img  of=<span class="string">&quot;<span class="variable">$13</span>&quot;</span> conv=fdatasync</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;****************烧写完成*********************************&quot;</span></span><br><span class="line"><span class="keyword">elif</span> [ <span class="variable">$which</span> -eq 1 ]</span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;****************开始trusted烧写**************************&quot;</span></span><br><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=tf-a-stm32mp157a-fsmp1a-trusted.stm32 of=<span class="string">&quot;<span class="variable">$11</span>&quot;</span> conv=fdatasync</span><br><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=tf-a-stm32mp157a-fsmp1a-trusted.stm32 of=<span class="string">&quot;<span class="variable">$12</span>&quot;</span> conv=fdatasync</span><br><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=u-boot.stm32  of=<span class="string">&quot;<span class="variable">$13</span>&quot;</span> conv=fdatasync</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;****************烧写完成*********************************&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;选择错误，退出，请重试.......&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure></li>
<li>解决错误<br><img src="/../image/U-BOOTerr1.png" alt="u-boot error 1"><br>当前u-boot源码是支持DK1板子的，而FSMP1A板子的设备树文件是基于DK1板子的设备树文件拷贝生成的。猜测导致FSMP1A板子的u-boot启动失败的原因是DK1板子和FSMP1A板子的电源管理单元的电路图设计不同，对比DK1和FSMP1A板子的电源管理单元的电路图。<br>在 <code>stm32mp15xx-fsmp1x.dtsi</code> 中，删除 <code>i2c4</code> <code>cpu0</code> <code>cpu1</code> <code>usbotg_hs 中的 port</code> <code>pmic</code> 设备树节点，并添加固定电源设备树节点信息。<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// delete</span></span><br><span class="line">   <span class="variable">&amp;i2c4</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>, <span class="string">&quot;sleep&quot;</span><span class="punctuation">;</span></span><br><span class="line">       pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;i2c4_pins_a</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">   <span class="comment">/* ...... */</span>   </span><br><span class="line">       <span class="punctuation">&#125;;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">   <span class="variable">&amp;cpu0</span><span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">cpu-supply</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;vddcore</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line">                                                                                           </span><br><span class="line">   <span class="variable">&amp;cpu1</span><span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">cpu-supply</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;vddcore</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">   <span class="title class_">port</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="symbol">       usbotg_hs_ep:</span> <span class="title class_">endpoint</span> <span class="punctuation">&#123;</span></span><br><span class="line">           <span class="attr">remote-endpoint</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;con_usbotg_hs_ep</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="punctuation">&#125;;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">   <span class="variable">&amp;pmic</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">u-boot,dm-pre-reloc</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// add</span></span><br><span class="line"><span class="symbol">   vin:</span> <span class="title class_">vin</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;vin&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">5000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">5000000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line">在vin节点的下边添加以下内容</span><br><span class="line"><span class="symbol">   v3v3:</span> <span class="title class_">regulator-3p3v</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;v3v3&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-boot-on</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol">   v1v8_audio:</span> <span class="title class_">regulator-v1v8-audio</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;v1v8_audio&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1800000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1800000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-boot-on</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol">   v3v3_hdmi:</span> <span class="title class_">regulator-v3v3-hdmi</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;v3v3_hdmi&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-boot-on</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol">   v1v2_hdmi:</span> <span class="title class_">regulator-v1v2-hdmi</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;v1v2_hdmi&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1200000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">1200000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-boot-on</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol">   vdd:</span> <span class="title class_">regulator-vdd</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;vdd&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-boot-on</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br><span class="line"><span class="symbol">   vdd_usb:</span> <span class="title class_">regulator-vdd-usb</span> <span class="punctuation">&#123;</span></span><br><span class="line">       <span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;regulator-fixed&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-name</span> <span class="operator">=</span> <span class="string">&quot;vdd_usb&quot;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-min-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-max-microvolt</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">3300000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-always-on</span><span class="punctuation">;</span></span><br><span class="line">       <span class="attr">regulator-boot-on</span><span class="punctuation">;</span></span><br><span class="line">   <span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>
移出 PMIC 的驱动代码<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line"><span class="comment"># Device Drivers  ---&gt; power  ---&gt;  [] Enable support for STMicroelectronics STPMIC1PMIC</span></span><br></pre></td></tr></table></figure>
重新编译   </li>
<li>解决错误<br><img src="/../image/U-BOOTerr2.png" alt="u-boot error 2"><br>当前u-boot源码是支持DK1板子的，而FSMP1A板子的设备树文件是基于DK1板子的设备树文件拷贝生成的。猜测导致FSMP1A板子的u-boot启动失败的原因是DK1板子和FSMP1A板子的DARM电路图的设计不同，对比DK1和FSMP1A板子的DRAM的电路图。<br>修改使用的设备树<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line"><span class="comment"># Device Tree Control ---&gt;  (stm32mp157a-fsmp1a) Default Device Tree for DT control</span></span><br></pre></td></tr></table></figure>
重新编译</li>
<li>解决错误<br><img src="/../image/U-BOOTerr3.png" alt="u-boot error 3"><br>当前FSMP1A板子的启动方式为TF卡启动，因此mmc初始化失败的错误跟eMMC设备的驱动无关。因此造成mmc初始化失败的原因应该是TF卡的驱动的问题。分析DK1板子和FSMP1A板子的TF卡的电路图。<br>修改 <code>stm32mp15xx-fsmp1x.dtsi</code><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&amp;sdmmc1</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>, <span class="string">&quot;opendrain&quot;</span>, <span class="string">&quot;sleep&quot;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;sdmmc1_b4_pins_a</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-1</span> = <span class="params">&lt;<span class="variable">&amp;sdmmc1_b4_od_pins_a</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-2</span> = <span class="params">&lt;<span class="variable">&amp;sdmmc1_b4_sleep_pins_a</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">cd-gpios</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;gpioh</span> <span class="number">3</span> (GPIO_ACTIVE_LOW | GPIO_PULL_UP)&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">disable-wp</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">st,neg-edge</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">bus-width</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">4</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">vmmc-supply</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;v3v3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>
重新编译</li>
<li>解决ADC错误 <code>can&#39;t enable vdd-supply! single shot failed for adc@0[18]</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line"><span class="comment"># Command line interface  ---&gt; Device access commands  ---&gt; [ ] adc - Access Analog to Digital Converters info and data</span></span><br><span class="line"><span class="comment"># Device Drivers  ---&gt; [ ] Enable ADC drivers using Driver Model</span></span><br></pre></td></tr></table></figure>
重新编译</li>
<li>修改命令提示符<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line"><span class="comment"># Command line interface  ---&gt; (FSMP1A&gt; ) Shell prompt</span></span><br></pre></td></tr></table></figure>
重新编译</li>
</ol>
<h2 id="移植eMMC驱动"><a href="#移植eMMC驱动" class="headerlink" title="移植eMMC驱动"></a>移植eMMC驱动</h2><p>分析eMMC的电路图<br><code>arch/arm/dts/stm32mp15xx-fsmp1x.dtsi</code> 增加 <code>SDMMC2</code> 的信息在原有 sdmmc1 节点下增加 sdmmc<br><code>arch/arm/dts/stm32mp157a-fsmp1a-u-boot.dtsi</code> 增加 <code>mmc 映射</code></p>
<pre><code><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">&amp;sdmmc2</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">pinctrl-names</span> <span class="operator">=</span> <span class="string">&quot;default&quot;</span>, <span class="string">&quot;opendrain&quot;</span>, <span class="string">&quot;sleep&quot;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-0</span> = <span class="params">&lt;<span class="variable">&amp;sdmmc2_b4_pins_a</span> <span class="variable">&amp;sdmmc2_d47_pins_a</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-1</span> = <span class="params">&lt;<span class="variable">&amp;sdmmc2_b4_od_pins_a</span> <span class="variable">&amp;sdmmc2_d47_pins_a</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    pinctrl<span class="number">-2</span> = <span class="params">&lt;<span class="variable">&amp;sdmmc2_b4_sleep_pins_a</span> <span class="variable">&amp;sdmmc2_d47_sleep_pins_a</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">non-removable</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">no-sd</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">no-sdio</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">st,neg-edge</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">bus-width</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">8</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">vmmc-supply</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;v3v3</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    <span class="attr">vqmmc-supply</span> <span class="operator">=</span> <span class="params">&lt;<span class="variable">&amp;vdd</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line">    mmc-ddr<span class="number">-3</span>_3v<span class="punctuation">;</span></span><br><span class="line">    <span class="attr">status</span> <span class="operator">=</span> <span class="string">&quot;okay&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span>    </span><br><span class="line"></span><br><span class="line"><span class="title class_">aliases</span> <span class="punctuation">&#123;</span></span><br><span class="line">    i2c3 = <span class="variable">&amp;i2c4</span><span class="punctuation">;</span></span><br><span class="line">    mmc0 = <span class="variable">&amp;sdmmc1</span><span class="punctuation">;</span></span><br><span class="line">    mmc1 = <span class="variable">&amp;sdmmc2</span><span class="punctuation">;</span></span><br><span class="line">    usb0 = <span class="variable">&amp;usbotg_hs</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="comment">// 在 sdmmc1 节点后 添加sdmmc2 的内容：</span></span><br><span class="line"><span class="variable">&amp;sdmmc1</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">u-boot,dm-spl</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br><span class="line"><span class="comment">// 以下内容为添加的新的内容：</span></span><br><span class="line"><span class="variable">&amp;sdmmc2</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">u-boot,dm-spl</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h1 id="kernel"><a href="#kernel" class="headerlink" title="kernel"></a>kernel</h1><h2 id="分析-kernel-源码"><a href="#分析-kernel-源码" class="headerlink" title="分析 kernel 源码"></a>分析 kernel 源码</h2><ol>
<li>拷贝 kernel 源码 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /mnt/hgfs/en.SOURCES-stm32mp1-openstlinux-5.10-dunfell-mp1-21-11-17_tar_v3.1.0.x ~/</span><br><span class="line">tar -xvf en.SOURCES-stm32mp1-openstlinux-5.10-dunfell-mp1-21-11-17_tar_v3.1.0.x</span><br></pre></td></tr></table></figure></li>
<li>目录结构<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0001-ARM-5.10.61-stm32mp1-r2-MACHINE.patch  &lt;===内核的补丁文件</span></span><br><span class="line"><span class="comment"># 0002-ARM-5.10.61-stm32mp1-r2-CLOCK.patch</span></span><br><span class="line"><span class="comment"># 0003-ARM-5.10.61-stm32mp1-r2-CPUFREQ.patch</span></span><br><span class="line"><span class="comment"># 0004-ARM-5.10.61-stm32mp1-r2-CRYPTO.patch</span></span><br><span class="line"><span class="comment"># 0005-ARM-5.10.61-stm32mp1-r2-DMA.patch</span></span><br><span class="line"><span class="comment"># 0006-ARM-5.10.61-stm32mp1-r2-DRM.patch</span></span><br><span class="line"><span class="comment"># 0007-ARM-5.10.61-stm32mp1-r2-HWSPINLOCK.patch</span></span><br><span class="line"><span class="comment"># 0008-ARM-5.10.61-stm32mp1-r2-I2C-IIO-IRQCHIP.patch</span></span><br><span class="line"><span class="comment"># 0009-ARM-5.10.61-stm32mp1-r2-MAILBOX-REMOTEPROC-RPMSG.patch</span></span><br><span class="line"><span class="comment"># 0010-ARM-5.10.61-stm32mp1-r2-MEDIA-SOC-THERMAL.patch</span></span><br><span class="line"><span class="comment"># 0011-ARM-5.10.61-stm32mp1-r2-MFD.patch</span></span><br><span class="line"><span class="comment"># 0012-ARM-5.10.61-stm32mp1-r2-MMC.patch</span></span><br><span class="line"><span class="comment"># 0013-ARM-5.10.61-stm32mp1-r2-NET-TTY.patch</span></span><br><span class="line"><span class="comment"># 0014-ARM-5.10.61-stm32mp1-r2-PERF.patch</span></span><br><span class="line"><span class="comment"># 0015-ARM-5.10.61-stm32mp1-r2-PHY-USB.patch</span></span><br><span class="line"><span class="comment"># 0016-ARM-5.10.61-stm32mp1-r2-PINCTRL-REGULATOR-SPI.patch</span></span><br><span class="line"><span class="comment"># 0017-ARM-5.10.61-stm32mp1-r2-RESET-RTC-WATCHDOG.patch</span></span><br><span class="line"><span class="comment"># 0018-ARM-5.10.61-stm32mp1-r2-SCMI.patch</span></span><br><span class="line"><span class="comment"># 0019-ARM-5.10.61-stm32mp1-r2-SOUND.patch</span></span><br><span class="line"><span class="comment"># 0020-ARM-5.10.61-stm32mp1-r2-MISC.patch</span></span><br><span class="line"><span class="comment"># 0021-ARM-5.10.61-stm32mp1-r2-CPUIDLE-POWER.patch</span></span><br><span class="line"><span class="comment"># 0022-ARM-5.10.61-stm32mp1-r2-DEVICETREE.patch</span></span><br><span class="line"><span class="comment"># 0023-ARM-5.10.61-stm32mp1-r2-CONFIG.patch</span></span><br><span class="line"><span class="comment"># fragment-03-systemd.config       &lt;====内核配置的补丁文件</span></span><br><span class="line"><span class="comment"># fragment-04-modules.config</span></span><br><span class="line"><span class="comment"># fragment-05-signature.config</span></span><br><span class="line"><span class="comment"># linux-5.10.61.tar.xz            &lt;======内核源代码</span></span><br><span class="line"><span class="comment"># README.HOW_TO.txt               &lt;======帮助文档</span></span><br><span class="line"><span class="comment"># series                           &lt;======补丁文件的层级</span></span><br></pre></td></tr></table></figure></li>
<li>解压内核<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf linux-5.10.61.tar.xz</span><br><span class="line"><span class="built_in">cd</span> linux-5.10.61</span><br></pre></td></tr></table></figure></li>
<li>目录结构<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># arch：</span></span><br><span class="line"><span class="comment">#  arm ：arm架构相关信息都在这个目录下   </span></span><br><span class="line"><span class="comment">#  linux-5.10.61/arch/arm/boot/uImage : 编译之后生成的内核镜像文件</span></span><br><span class="line"><span class="comment">#  linux-5.10.61/arch/arm/boot/dts : 设备树的源文件及二进制文件(stm32mp157a-fsmp1a.dtb)</span></span><br><span class="line"><span class="comment">#  arm/configs/xxx_defconfig : 内核中的默认配置文件    </span></span><br><span class="line"><span class="comment"># block : 块设备相关代码</span></span><br><span class="line"><span class="comment"># CREDITS : 内核的贡献者</span></span><br><span class="line"><span class="comment"># MAINTAINERS : 当前内核版本的维护者</span></span><br><span class="line"><span class="comment"># crypto : 加密解密算法</span></span><br><span class="line"><span class="comment"># Documentation : 内核帮助文档</span></span><br><span class="line"><span class="comment"># drivers ：这个目录下存放的是驱动</span></span><br><span class="line"><span class="comment"># fs      ：文件系统的相关代码</span></span><br><span class="line"><span class="comment"># include ：内核目录下的头文件</span></span><br><span class="line"><span class="comment"># init    ：系统初始化的代码</span></span><br><span class="line"><span class="comment"># ipc     ：进程间通信相关代码</span></span><br><span class="line"><span class="comment"># scripts ：内核编译相关的脚本文件，及Makefile库文件 </span></span><br><span class="line"><span class="comment"># kernel  ： 操作系统相关代码</span></span><br><span class="line"><span class="comment"># lib     ：内核的库文件</span></span><br><span class="line"><span class="comment"># mm      ：内存管理相关代码</span></span><br><span class="line"><span class="comment"># net     ：网络协议栈相关代码</span></span><br><span class="line"><span class="comment"># security：内核安全技术相关代码    </span></span><br></pre></td></tr></table></figure></li>
<li>打补丁<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> `<span class="built_in">ls</span> -1 ../*.patch`; <span class="keyword">do</span> patch -p1 &lt; <span class="variable">$p</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="kernel-启动流程"><a href="#kernel-启动流程" class="headerlink" title="kernel 启动流程"></a>kernel 启动流程</h2><p><img src="/../image/KERstart.png" alt="kernel start"></p>
<ol>
<li>完成内核自解压</li>
<li>判断CPUID是否正确，如果不正确就退出</li>
<li>接收uboot给内核传递的bootargs的参数</li>
<li>将物理内存映射得到虚拟内存，通过页表将物理内存和虚拟内存建立联系</li>
<li>跳转到c代码阶段（start_kernel）各种硬件的初始化（中断，终端，时间，调度，定时器）</li>
<li>在rest_init创建init和kthreadd线程，在init线程中执行&#x2F;sbin&#x2F;init</li>
<li>uboot将init&#x3D;&#x2F;linuxrc（&#x2F;bin&#x2F;busybox）传递给内核，此时根文件系统就挂载上去了</li>
</ol>
<h2 id="编译配置"><a href="#编译配置" class="headerlink" title="编译配置"></a>编译配置</h2><ol>
<li>生成自己的 <code>.config</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm multi_v7_defconfig fragment*.config</span><br></pre></td></tr></table></figure></li>
<li>修改 Makefile<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 370   ARCH  ?= $(SUBARCH)</span></span><br><span class="line"><span class="comment"># 371   ARCH ?= arm</span></span><br><span class="line"><span class="comment"># 372   CROSS_COMPILE ?= arm-linux-gnueabihf-</span></span><br></pre></td></tr></table></figure></li>
<li>设备树参考上文 <code>u-boot</code></li>
<li>错误 <code>can&#39;t create /proc/sys/kernel/hotplug: nonexistent directory</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">Device Drivers  ---&gt; Generic Driver Options  ---&gt; [*] Support <span class="keyword">for</span> uevent helper - (/sbin/hotplug) path to uevent helper (NEW)</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h1>
    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/10/25/%E5%BA%93%E7%9A%84%E5%88%B6%E4%BD%9C%E5%8F%8A%E4%BD%BF%E7%94%A8/" rel="prev" title="库的制作及使用">
      <i class="fa fa-chevron-left"></i> 库的制作及使用
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/01/14/%E6%80%BB%E7%BA%BF%E5%8D%8F%E8%AE%AE/" rel="next" title="总线协议">
      总线协议 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%A7%BB%E6%A4%8D"><span class="nav-number">1.</span> <span class="nav-text">系统移植</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E6%A4%8D%E5%89%8D%E5%87%86%E5%A4%87"><span class="nav-number">1.1.</span> <span class="nav-text">移植前准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Ubuntu-%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E5%99%A8"><span class="nav-number">1.1.1.</span> <span class="nav-text">1. Ubuntu 系统安装交叉编译器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Ubuntu-%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85tftp%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.2.</span> <span class="nav-text">2. Ubuntu 系统安装tftp服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Ubuntu-%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85nfs%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.3.</span> <span class="nav-text">3. Ubuntu 系统安装nfs服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E9%98%B6%E6%AE%B5%E9%83%A8%E7%BD%B2%E5%92%8C%E5%90%AF%E5%8A%A8"><span class="nav-number">1.2.</span> <span class="nav-text">开发阶段部署和启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%A7%E5%93%81%E9%98%B6%E6%AE%B5%E9%83%A8%E7%BD%B2%E5%92%8C%E5%90%AF%E5%8A%A8"><span class="nav-number">1.3.</span> <span class="nav-text">产品阶段部署和启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#TF-%E5%8D%A1%E7%9A%84%E5%88%86%E5%8C%BA"><span class="nav-number">1.3.1.</span> <span class="nav-text">TF 卡的分区</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#u-boot"><span class="nav-number">2.</span> <span class="nav-text">u-boot</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-u-boot-%E6%BA%90%E7%A0%81"><span class="nav-number">2.1.</span> <span class="nav-text">分析 u-boot 源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u-boot-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">2.2.</span> <span class="nav-text">u-boot 启动流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%BC%96%E8%AF%91"><span class="nav-number">2.3.</span> <span class="nav-text">配置编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%BB%E6%A4%8DeMMC%E9%A9%B1%E5%8A%A8"><span class="nav-number">2.4.</span> <span class="nav-text">移植eMMC驱动</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kernel"><span class="nav-number">3.</span> <span class="nav-text">kernel</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-kernel-%E6%BA%90%E7%A0%81"><span class="nav-number">3.1.</span> <span class="nav-text">分析 kernel 源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.2.</span> <span class="nav-text">kernel 启动流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E9%85%8D%E7%BD%AE"><span class="nav-number">3.3.</span> <span class="nav-text">编译配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#rootfs"><span class="nav-number">4.</span> <span class="nav-text">rootfs</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">XiaoMingMingBai</p>
  <div class="site-description" itemprop="description">选择有时候比努力更重要</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">10</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xiaomingmingbai" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaomingmingbai" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:xiaomingmingbai@outlook.com" title="E-Mail → mailto:xiaomingmingbai@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">XiaoMingMingBai</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">37k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">1:08</span>
</div>
  <div class="powered-by">
    <!--由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动 -->
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
